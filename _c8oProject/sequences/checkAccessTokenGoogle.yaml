authenticatedContextRequired: true
comment: |
  Checks is a valid access token is held by the current user's session for Google. If the token is not present, will use the current Convertigo user profile to get the refresh_token and use it to regenerate a valid acess token.
  
  
  
  
  
  
↓GetTokenFromUserSession [steps.SessionGetStep-1607691398179]: 
  comment: Get the google Sheet oAuth token form current user session
  key: oAuthAccessTokenGoogleSheet
  output: false
↓IfExistThenElse [steps.IfExistThenElseStep-1608745385084]: 
  sourceDefinition: 
    - xmlizable: 
      - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
      - com.twinsoft.convertigo.beans.common.XMLVector: 
        - java.lang.String: 
          - ↑value: 1607691398179
        - java.lang.String: 
          - ↑value: ./expression/text()
  ↓jThen [steps.ThenStep-1608745385086]: 
    comment: We got the token, use it
    ↓Log [steps.LogStep-1608802467238]: 
      expression: '"We found a token in user session, so return it"'
      level: WARN
    ↓login [steps.XMLElementStep-1607691398185]: 
      nodeName: token
      nodeText: ok
      sourceDefinition: 
        - xmlizable: 
          - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
          - com.twinsoft.convertigo.beans.common.XMLVector: 
            - java.lang.String: 
              - ↑value: 1607691398179
            - java.lang.String: 
              - ↑value: ./expression/text()
    ↓Return [steps.ReturnStep-1607691398188]: 
  ↓jElse [steps.ElseStep-1608745385088]: 
    comment: No token found in session.. Try to get a new one using the refresh_token
    ↓Get_authenticated_user [steps.GetAuthenticatedUserStep-1608745429916]: 
      comment: We need to know wo we are to retrieb the user profile
      output: false
    ↓Call_Sequence [steps.SequenceStep-1608745455777]: 
      comment: Get the Resfesh token attribute form the user profile
      sourceSequence: lib_UserManager.GetUserAttribute
      ↓user [variables.StepVariable-1608745474603]: 
        comment: The user where we have to set the attribute on
        sourceDefinition: 
          - xmlizable: 
            - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
            - com.twinsoft.convertigo.beans.common.XMLVector: 
              - java.lang.String: 
                - ↑value: 1608745429916
              - java.lang.String: 
                - ↑value: ./text()
      ↓attribute [variables.StepVariable-1608745474605]: 
        comment: The attribute name
        value: GoogleOAuthRefreshToken
    ↓IfExistThenElse [steps.IfExistThenElseStep-1608745524150]: 
      comment: If we have one ...
      sourceDefinition: 
        - xmlizable: 
          - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
          - com.twinsoft.convertigo.beans.common.XMLVector: 
            - java.lang.String: 
              - ↑value: 1608745455777
            - java.lang.String: 
              - ↑value: ./document/value
      ↓jThen [steps.ThenStep-1608745524704]: 
        comment: Use it
        ↓Log [steps.LogStep-1608803200792]: 
          expression: '"A refresh token is available, requesting from it an acess token..."'
          level: WARN
        ↓Call_Transaction [steps.TransactionStep-1608745882803]: 
          comment: Use google API to regenerate an Acess token from the refresh token
          sourceTransaction: lib_GoogleSheet.GoogleOAuth.RefreshToken
          ↓client_id [variables.StepVariable-1608745882809]: 
            value: ${lib_oauth.google.clientid}
          ↓client_secret [variables.StepVariable-1608745882812]: 
            value: 
              - ↑ciphered: true
              - ↑traceable: false
              - →→: xe3e8d34ac6f50dd03fb1b49b167dde8acf4e108275aa6607ecdc1742b13dc0f244477d0843c75b183120fdd6a8e52211
            visibility: '-1'
          ↓grant_type [variables.StepVariable-1608745882818]: 
            value: refresh_token
          ↓refresh_token [variables.StepVariable-1608746755925]: 
            sourceDefinition: 
              - xmlizable: 
                - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
                - com.twinsoft.convertigo.beans.common.XMLVector: 
                  - java.lang.String: 
                    - ↑value: 1608745455777
                  - java.lang.String: 
                    - ↑value: ./document/value/text()
            value: refresh_token
        ↓IfExist [steps.IfExistThenElseStep-1657028506857]: 
          sourceDefinition: 
            - xmlizable: 
              - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
              - com.twinsoft.convertigo.beans.common.XMLVector: 
                - java.lang.String: 
                  - ↑value: 1608745882803
                - java.lang.String: 
                  - ↑value: ./document/object/access_token/text()
          ↓jThen [steps.ThenStep-1657028506859]: 
            comment: Sucess !
            ↓login [steps.XMLElementStep-1608803265338]: 
              comment: Use the new Acess token
              nodeName: token
              nodeText: ok
              sourceDefinition: 
                - xmlizable: 
                  - ↑classname: com.twinsoft.convertigo.beans.common.XMLVector
                  - com.twinsoft.convertigo.beans.common.XMLVector: 
                    - java.lang.String: 
                      - ↑value: 1608745882803
                    - java.lang.String: 
                      - ↑value: ./document/object/access_token/text()
            ↓SetOAuthTokenInSession [steps.SessionSetStep-1608803530793]: 
              comment: Save the new Acess token in session
              expression: 
                - xmlizable: 
                  - ↑classname: com.twinsoft.convertigo.beans.steps.SmartType
                  - SmartType: 
                    - ↑mode: SOURCE
                    - com.twinsoft.convertigo.beans.common.XMLVector: 
                      - java.lang.String: 
                        - ↑value: 1608803265338
                      - java.lang.String: 
                        - ↑value: ./text()
              key: oAuthAccessTokenGoogle
            ↓Return [steps.ReturnStep-1608803265341]: 
              comment: Stop
          ↓jElse [steps.ElseStep-1657028506861]: 
            comment: Error
            ↓SetOAuthTokenInSession [steps.SessionSetStep-1657028686587]: 
              comment: Save a Null token
              expression: 
                - xmlizable: 
                  - ↑classname: com.twinsoft.convertigo.beans.steps.SmartType
                  - SmartType: 
                    - ↑mode: JS
                    - →→: null
              key: oAuthAccessTokenGoogleSheet
            ↓Error_structure [steps.XMLErrorStep-1657028528190]: 
              comment: Signal
              details: 
                - xmlizable: 
                  - ↑classname: com.twinsoft.convertigo.beans.steps.SmartType
                  - SmartType: 
                    - ↑mode: SOURCE
                    - com.twinsoft.convertigo.beans.common.XMLVector: 
                      - java.lang.String: 
                        - ↑value: 1608745882803
                      - java.lang.String: 
                        - ↑value: ./document/object/error_description/text()
              message: 
                - xmlizable: 
                  - ↑classname: com.twinsoft.convertigo.beans.steps.SmartType
                  - SmartType: 
                    - ↑mode: PLAIN
                    - →→: No Token has been refreshed, API error
            ↓Log [steps.LogStep-1657028727493]: 
              comment: Log
              expression: '"Token was not refreshed"'
              level: ERROR
            ↓Return [steps.ReturnStep-1657086784049]: 
              comment: Stop
      ↓jElse [steps.ElseStep-1608745524706]: 
        comment: No refresh token  available ...
        ↓SetOAuthTokenInSession [steps.SessionSetStep-1657086967390]: 
          comment: Save a Null token
          expression: 
            - xmlizable: 
              - ↑classname: com.twinsoft.convertigo.beans.steps.SmartType
              - SmartType: 
                - ↑mode: JS
                - →→: null
          key: oAuthAccessTokenGoogleSheet
        ↓Log [steps.LogStep-1608802298245]: 
          comment: No refresh token available
          expression: '"No refresh token avilable for this user, So return no token"'
          level: WARN
        ↓login [steps.XMLElementStep-1607691398191]: 
          comment: So we stop there, OAuth Failed
          nodeName: notoken
          nodeText: true
        ↓Log1 [steps.LogStep-1657086864220]: 
          comment: Log
          expression: '"No refresh token is available in user profile"'
          level: ERROR
        ↓Error_structure [steps.XMLErrorStep-1657086910365]: 
          comment: Signal
          details: 
            - xmlizable: 
              - ↑classname: com.twinsoft.convertigo.beans.steps.SmartType
              - SmartType: 
                - ↑mode: SOURCE
                - com.twinsoft.convertigo.beans.common.XMLVector: 
                  - java.lang.String: 
                    - ↑value: 1608745882803
                  - java.lang.String: 
                    - ↑value: ./document/object/error_description/text()
          message: 
            - xmlizable: 
              - ↑classname: com.twinsoft.convertigo.beans.steps.SmartType
              - SmartType: 
                - ↑mode: PLAIN
                - →→: No refresh token is available in user profile